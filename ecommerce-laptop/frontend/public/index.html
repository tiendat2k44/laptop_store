<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="LaptopStore - Mua laptop chính hãng, giá tốt. Laptop gaming, văn phòng, đồ họa, sinh viên." />
  <title>Laptop Store - Mua Laptop Chính Hãng Giá Tốt</title>

  <!-- Styles -->
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/responsive.css" />

  <!-- Font Awesome (defer loading bằng preconnect + tải bình thường) -->
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <style>
    /* Tiny inline helper for simple loading states (kept minimal) */
    .product-loading { text-align: center; padding: 2rem; color: #666; }
    .no-products { text-align: center; padding: 2rem; }
    /* improve focus outlines for accessibility */
    a:focus, button:focus { outline: 3px solid rgba(21,156,228,0.4); outline-offset: 2px; }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header" role="banner">
    <div class="container">
      <div class="header-main">
        <!-- Logo -->
        <div class="logo">
          <a href="index.html" aria-label="Trang chủ LaptopStore">
            <i class="fas fa-laptop" aria-hidden="true"></i>
            <span>LaptopStore</span>
          </a>
        </div>

        <!-- Search Bar -->
        <div class="search-bar" role="search">
          <label for="searchInput" class="visually-hidden">Tìm kiếm sản phẩm</label>
          <input type="search" id="searchInput" placeholder="Tìm kiếm laptop..." />
          <button id="searchBtn" aria-label="Tìm kiếm"><i class="fas fa-search"></i></button>
        </div>

        <!-- Header Actions -->
        <div class="header-actions" aria-live="polite">
          <a href="wishlist.html" class="header-icon" aria-label="Yêu thích">
            <i class="far fa-heart" aria-hidden="true"></i>
            <span class="badge" id="wishlistCount">0</span>
          </a>
          <a href="cart.html" class="header-icon" aria-label="Giỏ hàng">
            <i class="fas fa-shopping-cart" aria-hidden="true"></i>
            <span class="badge" id="cartCount">0</span>
          </a>
          <div class="user-menu">
            <button class="user-btn" id="userBtn" aria-haspopup="true" aria-expanded="false" aria-controls="userDropdown">
              <i class="far fa-user" aria-hidden="true"></i>
              <span id="userName">Đăng nhập</span>
            </button>
            <div class="user-dropdown" id="userDropdown" role="menu" aria-hidden="true">
              <!-- Logged out state -->
              <div id="loggedOutMenu">
                <a href="login.html" role="menuitem"><i class="fas fa-sign-in-alt"></i> Đăng nhập</a>
                <a href="register.html" role="menuitem"><i class="fas fa-user-plus"></i> Đăng ký</a>
              </div>
              <!-- Logged in state -->
              <div id="loggedInMenu" style="display: none;">
                <a href="profile.html" role="menuitem"><i class="fas fa-user"></i> Tài khoản</a>
                <a href="orders.html" role="menuitem"><i class="fas fa-box"></i> Đơn hàng</a>
                <a href="wishlist.html" role="menuitem"><i class="fas fa-heart"></i> Yêu thích</a>
                <div class="dropdown-divider" aria-hidden="true"></div>
                <button id="logoutBtn" role="menuitem" class="link-button"><i class="fas fa-sign-out-alt"></i> Đăng xuất</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Navigation -->
      <nav class="main-nav" role="navigation" aria-label="Main navigation">
        <ul>
          <li><a href="index.html" class="active"><i class="fas fa-home" aria-hidden="true"></i> Trang chủ</a></li>
          <li><a href="products.html"><i class="fas fa-laptop" aria-hidden="true"></i> Sản phẩm</a></li>
          <li class="dropdown">
            <a href="#" aria-haspopup="true" aria-expanded="false"><i class="fas fa-list"></i> Danh mục <i class="fas fa-chevron-down"></i></a>
            <ul class="dropdown-menu" id="categoryMenu" aria-label="Danh mục sản phẩm">
              <li><a href="products.html?category=gaming">Laptop Gaming</a></li>
              <li><a href="products.html?category=office">Laptop Văn Phòng</a></li>
              <li><a href="products.html?category=design">Laptop Đồ Họa</a></li>
              <li><a href="products.html?category=student">Laptop Sinh Viên</a></li>
            </ul>
          </li>
          <li class="dropdown">
            <a href="#" aria-haspopup="true" aria-expanded="false"><i class="fas fa-tag"></i> Thương hiệu <i class="fas fa-chevron-down"></i></a>
            <ul class="dropdown-menu" id="brandMenu" aria-label="Thương hiệu">
              <li><a href="products.html?brand=dell">Dell</a></li>
              <li><a href="products.html?brand=hp">HP</a></li>
              <li><a href="products.html?brand=lenovo">Lenovo</a></li>
              <li><a href="products.html?brand=asus">Asus</a></li>
              <li><a href="products.html?brand=acer">Acer</a></li>
              <li><a href="products.html?brand=msi">MSI</a></li>
            </ul>
          </li>
          <li><a href="#"><i class="fas fa-percent"></i> Khuyến mãi</a></li>
          <li><a href="#"><i class="fas fa-newspaper"></i> Tin tức</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- Hero Slider -->
  <section class="hero-slider" aria-roledescription="carousel">
    <div class="slider-container">
      <div class="slide active" data-slide="0">
        <img loading="lazy" src="https://via.placeholder.com/1200x400/007bff/ffffff?text=Gaming+Laptop+Sale" alt="Gaming Laptop Sale" />
        <div class="slide-content">
          <h2>Laptop Gaming Giá Tốt</h2>
          <p>Giảm giá lên đến 30%</p>
          <a href="products.html?category=gaming" class="btn btn-primary">Mua ngay</a>
        </div>
      </div>
      <div class="slide" data-slide="1">
        <img loading="lazy" src="https://via.placeholder.com/1200x400/28a745/ffffff?text=Office+Laptop" alt="Office Laptop" />
        <div class="slide-content">
          <h2>Laptop Văn Phòng</h2>
          <p>Hiệu suất cao, giá cả phải chăng</p>
          <a href="products.html?category=office" class="btn btn-primary">Khám phá</a>
        </div>
      </div>
    </div>
    <button class="slider-btn prev" aria-label="Slide trước"><i class="fas fa-chevron-left"></i></button>
    <button class="slider-btn next" aria-label="Slide sau"><i class="fas fa-chevron-right"></i></button>
  </section>

  <!-- Featured Categories -->
  <section class="categories-section">
    <div class="container">
      <h2 class="section-title">Danh Mục Nổi Bật</h2>
      <div class="categories-grid">
        <div class="category-card">
          <img loading="lazy" src="https://via.placeholder.com/200x150/ff6b6b/ffffff?text=Gaming" alt="Gaming" />
          <h3>Laptop Gaming</h3>
          <p>Hiệu năng khủng cho game thủ</p>
          <a href="products.html?category=gaming" class="btn-link">Xem ngay <i class="fas fa-arrow-right"></i></a>
        </div>
        <div class="category-card">
          <img loading="lazy" src="https://via.placeholder.com/200x150/4ecdc4/ffffff?text=Office" alt="Office" />
          <h3>Văn Phòng</h3>
          <p>Làm việc hiệu quả mọi lúc</p>
          <a href="products.html?category=office" class="btn-link">Xem ngay <i class="fas fa-arrow-right"></i></a>
        </div>
        <div class="category-card">
          <img loading="lazy" src="https://via.placeholder.com/200x150/95e1d3/ffffff?text=Design" alt="Design" />
          <h3>Đồ Họa</h3>
          <p>Sáng tạo không giới hạn</p>
          <a href="products.html?category=design" class="btn-link">Xem ngay <i class="fas fa-arrow-right"></i></a>
        </div>
        <div class="category-card">
          <img loading="lazy" src="https://via.placeholder.com/200x150/f38181/ffffff?text=Student" alt="Student" />
          <h3>Sinh Viên</h3>
          <p>Phù hợp túi tiền, hiệu quả cao</p>
          <a href="products.html?category=student" class="btn-link">Xem ngay <i class="fas fa-arrow-right"></i></a>
        </div>
      </div>
    </div>
  </section>

  <!-- Hot Products -->
  <section class="products-section">
    <div class="container">
      <div class="section-header">
        <h2 class="section-title">Sản Phẩm Bán Chạy</h2>
        <a href="products.html" class="view-all">Xem tất cả <i class="fas fa-arrow-right"></i></a>
      </div>
      <div class="products-grid" id="hotProducts">
        <div class="product-loading"><i class="fas fa-spinner fa-spin" aria-hidden="true"></i> Đang tải sản phẩm...</div>
      </div>
    </div>
  </section>

  <!-- Discount Products -->
  <section class="products-section bg-light">
    <div class="container">
      <div class="section-header">
        <h2 class="section-title">Sản Phẩm Khuyến Mãi</h2>
        <a href="products.html?discount=true" class="view-all">Xem tất cả <i class="fas fa-arrow-right"></i></a>
      </div>
      <div class="products-grid" id="discountProducts">
        <div class="product-loading"><i class="fas fa-spinner fa-spin" aria-hidden="true"></i> Đang tải sản phẩm...</div>
      </div>
    </div>
  </section>

  <!-- Brands -->
  <section class="brands-section">
    <div class="container">
      <h2 class="section-title">Thương Hiệu Uy Tín</h2>
      <div class="brands-grid">
        <div class="brand-item"><img loading="lazy" src="https://via.placeholder.com/150x80/ffffff/333333?text=Dell" alt="Dell" /></div>
        <div class="brand-item"><img loading="lazy" src="https://via.placeholder.com/150x80/ffffff/333333?text=HP" alt="HP" /></div>
        <div class="brand-item"><img loading="lazy" src="https://via.placeholder.com/150x80/ffffff/333333?text=Lenovo" alt="Lenovo" /></div>
        <div class="brand-item"><img loading="lazy" src="https://via.placeholder.com/150x80/ffffff/333333?text=Asus" alt="Asus" /></div>
        <div class="brand-item"><img loading="lazy" src="https://via.placeholder.com/150x80/ffffff/333333?text=Acer" alt="Acer" /></div>
        <div class="brand-item"><img loading="lazy" src="https://via.placeholder.com/150x80/ffffff/333333?text=MSI" alt="MSI" /></div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="footer" role="contentinfo">
    <div class="container">
      <div class="footer-content">
        <div class="footer-col">
          <h3>Về LaptopStore</h3>
          <p>Chuyên cung cấp laptop chính hãng với giá tốt nhất thị trường. Uy tín - Chất lượng - Bảo hành chu đáo.</p>
          <div class="social-links">
            <a href="#" aria-label="Facebook"><i class="fab fa-facebook"></i></a>
            <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
            <a href="#" aria-label="YouTube"><i class="fab fa-youtube"></i></a>
            <a href="#" aria-label="TikTok"><i class="fab fa-tiktok"></i></a>
          </div>
        </div>
        <div class="footer-col">
          <h3>Hỗ Trợ Khách Hàng</h3>
          <ul>
            <li><a href="#">Hướng dẫn mua hàng</a></li>
            <li><a href="#">Chính sách bảo hành</a></li>
            <li><a href="#">Chính sách đổi trả</a></li>
            <li><a href="#">Câu hỏi thường gặp</a></li>
          </ul>
        </div>
        <div class="footer-col">
          <h3>Chính Sách</h3>
          <ul>
            <li><a href="#">Chính sách bảo mật</a></li>
            <li><a href="#">Điều khoản sử dụng</a></li>
            <li><a href="#">Chính sách thanh toán</a></li>
            <li><a href="#">Chính sách vận chuyển</a></li>
          </ul>
        </div>
        <div class="footer-col">
          <h3>Liên Hệ</h3>
          <ul>
            <li><i class="fas fa-map-marker-alt"></i> 123 Đường ABC, Quận 1, TP.HCM</li>
            <li><i class="fas fa-phone"></i> 1900-xxxx</li>
            <li><i class="fas fa-envelope"></i> support@laptopstore.com</li>
            <li><i class="fas fa-clock"></i> 8:00 - 22:00 (Hàng ngày)</li>
          </ul>
        </div>
      </div>
      <div class="footer-bottom">
        <p>&copy; 2024 LaptopStore. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <!-- Main script: improved logic for slider, products, and event delegation -->
  <script>
    // Fallback API_URL: backend should expose a global API_URL or set via env-injection
    const API_URL = (window.API_URL && window.API_URL.replace(/\/+$/, '')) || 'http://localhost:5000/api';

    // Utility: format currency (VND)
    function formatCurrency(value) {
      if (typeof value !== 'number') return '';
      return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value);
    }

    // Accessibility helper: toggle aria-expanded + aria-hidden
    function toggleDropdown(button, dropdown) {
      const expanded = button.getAttribute('aria-expanded') === 'true';
      button.setAttribute('aria-expanded', String(!expanded));
      dropdown.setAttribute('aria-hidden', String(expanded));
      dropdown.style.display = expanded ? 'none' : 'block';
    }

    // Slider: robust implementation with pause on hover/touch
    (function initSlider() {
      let intervalId = null;
      let current = 0;
      const container = document.querySelector('.hero-slider');
      if (!container) return;
      const slides = Array.from(container.querySelectorAll('.slide'));
      if (slides.length === 0) return;

      function show(index) {
        slides.forEach((s, i) => s.classList.toggle('active', i === index));
        current = (index + slides.length) % slides.length;
      }

      function next() { show(current + 1); }
      function prev() { show(current - 1); }

      container.querySelector('.next')?.addEventListener('click', () => { next(); resetInterval(); });
      container.querySelector('.prev')?.addEventListener('click', () => { prev(); resetInterval(); });

      // Auto slide
      function startInterval() {
        if (intervalId) clearInterval(intervalId);
        intervalId = setInterval(next, 5000);
      }
      function resetInterval() { startInterval(); }

      // Pause on hover/touch
      container.addEventListener('mouseenter', () => { clearInterval(intervalId); });
      container.addEventListener('mouseleave', startInterval);
      container.addEventListener('touchstart', () => { clearInterval(intervalId); }, { passive: true });
      container.addEventListener('touchend', startInterval);

      // init
      show(0);
      startInterval();
    })();

    // Event listeners for header user menu and global click handlers
    document.addEventListener('DOMContentLoaded', () => {
      const userBtn = document.getElementById('userBtn');
      const userDropdown = document.getElementById('userDropdown');

      if (userBtn && userDropdown) {
        userBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleDropdown(userBtn, userDropdown);
        });

        // Close when clicking outside
        document.addEventListener('click', (e) => {
          if (!userDropdown.contains(e.target) && e.target !== userBtn) {
            userBtn.setAttribute('aria-expanded', 'false');
            userDropdown.setAttribute('aria-hidden', 'true');
            userDropdown.style.display = 'none';
          }
        });
      }

      // Event delegation for product actions: add-to-cart, wishlist, quickview
      document.body.addEventListener('click', (e) => {
        const t = e.target.closest('[data-action]');
        if (!t) return;
        const action = t.getAttribute('data-action');
        const id = t.getAttribute('data-id');
        if (action === 'add-to-cart') {
          addToCartHandler(id);
        } else if (action === 'add-to-wishlist') {
          addToWishlistHandler(id);
        } else if (action === 'quick-view') {
          quickViewHandler(id);
        }
      });

      // wire search
      document.getElementById('searchBtn')?.addEventListener('click', () => {
        const q = document.getElementById('searchInput').value.trim();
        if (q) window.location.href = `products.html?search=${encodeURIComponent(q)}`;
      });

      // Load persistent counts
      updateHeaderCounts();

      // Load products
      loadProducts();
    });

    // Header counts (example using localStorage fallback)
    function updateHeaderCounts() {
      const cartCount = parseInt(localStorage.getItem('cart_count') || '0', 10);
      const wishlistCount = parseInt(localStorage.getItem('wishlist_count') || '0', 10);
      document.getElementById('cartCount').textContent = String(cartCount);
      document.getElementById('wishlistCount').textContent = String(wishlistCount);
    }

    // Handlers (placeholders)
    function addToCartHandler(productId) {
      // TODO: call backend API to add to cart; here we simulate and update count
      const current = parseInt(localStorage.getItem('cart_count') || '0', 10) + 1;
      localStorage.setItem('cart_count', String(current));
      updateHeaderCounts();
      alert('Đã thêm vào giỏ (demo). ID: ' + productId);
    }

    function addToWishlistHandler(productId) {
      const current = parseInt(localStorage.getItem('wishlist_count') || '0', 10) + 1;
      localStorage.setItem('wishlist_count', String(current));
      updateHeaderCounts();
      alert('Đã thêm vào yêu thích (demo). ID: ' + productId);
    }

    function quickViewHandler(productId) {
      // TODO: show product modal / quick view
      alert('Quick view (demo). ID: ' + productId);
    }

    // Load products safely and build DOM nodes (avoid raw innerHTML)
    async function loadProducts() {
      const hotContainer = document.getElementById('hotProducts');
      const discountContainer = document.getElementById('discountProducts');

      try {
        // Hot products by sold quantity
        const hotRes = await fetch(`${API_URL}/products?limit=8&sort_by=sold_quantity&sort_order=DESC`);
        const hotJson = await hotRes.json();
        const hotProducts = hotJson?.data?.products || [];
        renderProductsSafe(hotProducts, hotContainer);

        // Discounted products (example fetch; filter on client)
        const discRes = await fetch(`${API_URL}/products?limit=16`);
        const discJson = await discRes.json();
        const all = discJson?.data?.products || [];
        const discounted = all.filter(p => p.discount_price && Number(p.discount_price) < Number(p.price));
        renderProductsSafe(discounted.slice(0, 8), discountContainer);
      } catch (err) {
        console.error('Error loading products:', err);
        if (hotContainer) hotContainer.innerHTML = '<p class="error-message">Không thể tải sản phẩm</p>';
        if (discountContainer) discountContainer.innerHTML = '<p class="error-message">Không thể tải sản phẩm</p>';
      }
    }

    // Secure DOM creation for product cards
    function renderProductsSafe(products, container) {
      if (!container) return;
      container.innerHTML = '';
      if (!Array.isArray(products) || products.length === 0) {
        container.innerHTML = '<p class="no-products">Không có sản phẩm nào</p>';
        return;
      }

      const fragment = document.createDocumentFragment();
      products.forEach(product => {
        // Protect against unexpected shapes
        const id = String(product.product_id ?? product.id ?? '');
        const name = String(product.product_name ?? product.name ?? 'Sản phẩm');
        const price = Number(product.price ?? 0);
        const discount = product.discount_price ? Number(product.discount_price) : null;
        const img = (product.images && product.images[0]) ? product.images[0] : 'https://via.placeholder.com/300x200';
        const rating = Math.max(0, Math.min(5, Math.floor(product.rating_average || 0)));
        const reviewCount = product.review_count || 0;

        const card = document.createElement('div');
        card.className = 'product-card';

        if (discount) {
          const percent = Math.round((1 - discount / price) * 100);
          const badge = document.createElement('span');
          badge.className = 'badge-discount';
          badge.textContent = `-${percent}%`;
          card.appendChild(badge);
        }

        const imgWrap = document.createElement('div');
        imgWrap.className = 'product-image';
        const imgEl = document.createElement('img');
        imgEl.src = img;
        imgEl.alt = name;
        imgEl.loading = 'lazy';
        imgWrap.appendChild(imgEl);

        const actions = document.createElement('div');
        actions.className = 'product-actions';
        const wbtn = document.createElement('button');
        wbtn.className = 'btn-icon';
        wbtn.setAttribute('data-action', 'add-to-wishlist');
        wbtn.setAttribute('data-id', id);
        wbtn.innerHTML = '<i class="far fa-heart" aria-hidden="true"></i>';
        const qbtn = document.createElement('button');
        qbtn.className = 'btn-icon';
        qbtn.setAttribute('data-action', 'quick-view');
        qbtn.setAttribute('data-id', id);
        qbtn.innerHTML = '<i class="far fa-eye" aria-hidden="true"></i>';
        actions.appendChild(wbtn);
        actions.appendChild(qbtn);
        imgWrap.appendChild(actions);
        card.appendChild(imgWrap);

        const info = document.createElement('div');
        info.className = 'product-info';
        const title = document.createElement('h3');
        title.className = 'product-name';
        const link = document.createElement('a');
        link.href = `product-detail.html?id=${encodeURIComponent(id)}`;
        link.textContent = name;
        title.appendChild(link);
        info.appendChild(title);

        const ratingWrap = document.createElement('div');
        ratingWrap.className = 'product-rating';
        const stars = document.createElement('span');
        stars.className = 'stars';
        stars.textContent = '★'.repeat(rating) + '☆'.repeat(5 - rating);
        const rtText = document.createElement('span');
        rtText.className = 'rating-text';
        rtText.textContent = `(${reviewCount})`;
        ratingWrap.appendChild(stars);
        ratingWrap.appendChild(rtText);
        info.appendChild(ratingWrap);

        const priceWrap = document.createElement('div');
        priceWrap.className = 'product-price';
        if (discount) {
          const sale = document.createElement('span');
          sale.className = 'price-sale';
          sale.textContent = formatCurrency(discount);
          const orig = document.createElement('span');
          orig.className = 'price-original';
          orig.textContent = formatCurrency(price);
          priceWrap.appendChild(sale);
          priceWrap.appendChild(orig);
        } else {
          const sale = document.createElement('span');
          sale.className = 'price-sale';
          sale.textContent = formatCurrency(price);
          priceWrap.appendChild(sale);
        }
        info.appendChild(priceWrap);

        const btn = document.createElement('button');
        btn.className = 'btn btn-primary btn-block';
        btn.setAttribute('data-action', 'add-to-cart');
        btn.setAttribute('data-id', id);
        btn.innerHTML = '<i class="fas fa-shopping-cart" aria-hidden="true"></i> Thêm vào giỏ';
        info.appendChild(btn);

        card.appendChild(info);
        fragment.appendChild(card);
      });

      container.appendChild(fragment);
    }
  </script>

  <!-- External main.js (optional) -->
  <script src="js/main.js" defer></script>
</body>
</html>